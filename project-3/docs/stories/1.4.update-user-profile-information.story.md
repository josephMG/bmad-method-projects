# Story 1.4: Update User Profile Information

## Status
Done

## Story
**As an** authenticated user,
**I want** to update my basic profile information (e.g., name, email),
**so that** I can keep my personal details current in the system.

## Acceptance Criteria
1.  The system shall allow authenticated users to update their `full_name` and `email`.
2.  The system shall validate the provided `email` for uniqueness and correct format.
3.  The system shall return the updated user profile upon successful update.
4.  The system shall return an appropriate error if the user is unauthenticated or if the provided email is already in use by another user.
5.  The `updated_at` timestamp for the user record shall be automatically updated upon a successful profile modification.

## Tasks / Subtasks
- [x] **API Layer (app/api/v1/endpoints/users.py)**
  - [x] Implement `PUT /users/me` endpoint to handle profile updates. (AC: 1, 2, 3, 4)
  - [x] Use FastAPI's `Depends` to inject the current authenticated user. (AC: 1, 4)
  - [x] Validate incoming request body against `UserUpdate` schema. (AC: 2)
  - [x] Call the `UserService` to perform the update. (AC: 1, 2, 3, 4)
  - [x] Return `UserRead` schema upon success. (AC: 3)
- [x] **Business Logic Layer (app/services/user_service.py)**
  - [x] Create a `update_user_profile` method that takes the user ID and update data. (AC: 1, 2)
  - [x] Check if the new email (if provided) is already in use by another user (excluding the current user). Raise a specific exception if duplicate. (AC: 2, 4)
  - [x] Call the `CRUDUser` repository to update the user in the database. (AC: 1, 5)
  - [x] Handle `UserNotFoundException` if the user does not exist. (AC: 4)
- [x] **Data Access Layer (app/crud/crud_user.py)**
  - [x] Implement a `update_user` method that takes a user ID and a dictionary of fields to update. (AC: 1, 5)
  - [x] Ensure the `updated_at` field is automatically updated by the database trigger. (AC: 5)
- [x] **Pydantic Schemas (app/schemas/user.py)**
  - [x] Ensure `UserUpdate` schema correctly defines `full_name` and `email` fields.
  - [x] Ensure `UserRead` schema correctly defines the response structure.
- [x] **Testing**
  - [x] Write unit tests for `user_service.py::update_user_profile` covering: (AC: 1, 2, 3, 4)
    - [x] Successful update of `full_name` and `email`.
    - [x] Attempt to update with a duplicate email.
    - [x] Attempt to update a non-existent user.
    - [x] Verification that `updated_at` is handled by the database (mock `crud_user`).
  - [x] Write integration tests for `PUT /users/me` endpoint covering: (AC: 1, 2, 3, 4)
    - [x] Successful update with valid data for an authenticated user.
    - [x] Attempt to update with an invalid email format.
    - [x] Attempt to update with an email already registered by another user.
    - [x] Attempt to update as an unauthenticated user.
    - [x] Verification of the `updated_at` timestamp in the database.

## Dev Notes
- **Previous Story Insights**: No specific insights from previous stories directly impact this one, as previous stories focused on registration, TDD, and password changes.
- **Data Models**:
  - The `User` model in `app/models/user.py` will be updated. Relevant attributes are `full_name` (String, Optional), `email` (String, Unique, NOT NULL), and `updated_at` (DateTime, automatically updated by trigger). [Source: architecture.md#User Model]
  - Pydantic schemas `UserUpdate` and `UserRead` in `app/schemas/user.py` will be used for request and response validation/serialization. `UserUpdate` should include `full_name` and `email`. [Source: architecture.md#REST API Spec]
- **API Specifications**:
  - The API endpoint for updating user profile is `PUT /users/me`. [Source: architecture.md#REST API Spec]
  - It requires `bearerAuth` for authentication. [Source: architecture.md#REST API Spec]
  - The request body should conform to the `UserUpdate` schema, and the response will conform to the `UserRead` schema. [Source: architecture.md#REST API Spec]
- **File Locations**:
  - API endpoint: `user-management-service/app/api/v1/endpoints/users.py` [Source: architecture.md#Source Tree]
  - Business logic: `user-management-service/app/services/user_service.py` [Source: architecture.md#Source Tree]
  - Data Access (CRUD): `user-management-service/app/crud/crud_user.py` [Source: architecture.md#Source Tree]
  - ORM Model: `user-management-service/app/models/user.py` [Source: architecture.md#Source Tree]
  - Pydantic Schemas: `user-management-service/app/schemas/user.py` [Source: architecture.md#Source Tree]
- **Technical Constraints**:
  - All Python code must be compatible with Python 3.11. [Source: architecture.md#Coding Standards]
  - Use Ruff for linting and formatting. [Source: architecture.md#Coding Standards]
  - Business logic MUST be in `app/services/`. [Source: architecture.md#Critical Rules for AI Agents]
  - Database interactions MUST go through `app/crud/`. [Source: architecture.md#Critical Rules for AI Agents]
  - Dependencies MUST be acquired using FastAPI's `Depends`. [Source: architecture.md#Critical Rules for AI Agents]
  - Raise specific custom exceptions for business logic errors. [Source: architecture.md#Critical Rules for AI Agents]
- **Testing**:
  - **Approach**: Test-After Development. All code must be accompanied by tests in the same pull request. [Source: architecture.md#Test Strategy and Standards]
  - **Coverage Goals**: >90% code coverage on `services` and `crud` layers, overall >85%. [Source: architecture.md#Test Strategy and Standards]
  - **Unit Tests**:
    - Framework: Pytest. [Source: architecture.md#Test Types and Organization]
    - Location & Convention: `tests/unit/test_*.py`. [Source: architecture.md#Test Types and Organization]
    - Mocking Library: Python's built-in `unittest.mock`. [Source: architecture.md#Test Types and Organization]
    - Pattern: Arrange-Act-Assert. [Source: architecture.md#Test Types and Organization]
  - **Integration Tests**:
    - Location: `tests/integration/`. [Source: architecture.md#Test Types and Organization]
    - Database: Testcontainers for PostgreSQL. [Source: architecture.md#Test Types and Organization]
    - Cleanup: Isolated database transactions, rolled back after each test. [Source: architecture.md#Test Data Management]
- **Security**:
  - **Input Validation**: Pydantic at the API Boundary. Unknown fields will be rejected. [Source: architecture.md#Security]
  - **Authentication & Authorization**: JWT via `Authorization: Bearer <token>`. Stateless. Reusable FastAPI dependency for JWT validation on protected endpoints. [Source: architecture.md#Security]
  - **Data Protection**: `email` is PII, ensure it's handled securely. No plaintext passwords, API keys, or JWTs in logs. [Source: architecture.md#Security]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-25 | 1.0 | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Gemini
### Debug Log References
- Initial `pytest_mock` error and fix.
- `asyncio` marker error and `asyncio_mode = auto` fix.
- `KeyError: 'access_token'` and login endpoint correction.
- `updated_at` assertion failures and subsequent fixes in `crud_user.py` and `conftest.py`.
- Indentation errors in `test_users.py`.
### Completion Notes List
- Implemented `update_user_profile` functionality in `user_service.py` and `crud_user.py`.
- Added unit tests for `user_service.py`.
- Added integration tests for `PUT /users/me` endpoint.
- Refactored `conftest.py` to support async tests and provide necessary fixtures.
- Ensured `updated_at` timestamp is correctly handled and tested.
### File List
- `user-management-service/app/services/user_service.py`
- `user-management-service/app/crud/crud_user.py`
- `user-management-service/app/schemas/user.py`
- `user-management-service/app/models/user.py`
- `user-management-service/tests/unit/test_user_service.py`
- `user-management-service/tests/integration/test_users.py`
- `user-management-service/tests/conftest.py`
- `user-management-service/tests/integration/test_auth_api.py`
- `user-management-service/pyproject.toml`

## QA Results

### Review Date: 2025-09-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation for Story 1.4 is well-structured and adheres to the defined architectural principles (Service, CRUD layers, Pydantic schemas, SQLAlchemy ORM). The code is clear, readable, and follows Python coding standards.

### Refactoring Performed

No refactoring was performed during this review.

### Compliance Check

- Coding Standards: ✓ (Adheres to Python 3.11, Ruff, PEP 8, and critical AI agent rules.)
- Project Structure: ✓ (File locations align with `architecture.md#Source Tree`.)
- Testing Strategy: ✓ (Comprehensive unit and integration tests are present, covering all ACs.)
- All ACs Met: ✓ (All Acceptance Criteria are fully implemented and verified by tests.)

### Improvements Checklist

- [ ] The explicit `db_user.updated_at = datetime.utcnow()` in `crud_user.py` is redundant because the `User` model in `app/models/user.py` already handles `updated_at` automatically with `onupdate=func.now()`. While not a bug, removing this explicit setting would make the code cleaner and rely on the ORM's intended behavior.

### Security Review

The story implementation correctly handles input validation (email format, uniqueness) and relies on the existing authentication mechanism (JWT). Data protection for PII (email) is considered. No new security concerns were identified.

### Performance Considerations

No specific performance issues were identified. The chosen technologies (FastAPI, SQLAlchemy) are generally performant.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.4.update-user-profile-information.yml
Risk profile: N/A (Not generated for this review.)
NFR assessment: N/A (Not generated for this review.)

### Recommended Status

✓ Ready for Done (Ready for Development)
