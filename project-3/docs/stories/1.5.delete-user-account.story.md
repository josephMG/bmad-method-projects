# Story 1.5: Delete User Account

## Status
Done

## Tasks / Subtasks

- [x] **Task 1: Modify Account Deletion Endpoint**
  - [x] Subtask 1.1: Update the `DELETE /api/v1/users/me` endpoint in `app/api/v1/endpoints/users.py` to accept a request body containing the user's `current_password`.
  - [x] Subtask 1.2: Create a new Pydantic schema in `app/schemas/user.py` for this request body, named `UserDeletionRequest`.

- [x] **Task 2: Implement Re-authentication in Service Layer**
  - [x] Subtask 2.1: In `app/services/user_service.py`, modify the `delete_user_account` service to require the `current_password`.
  - [x] Subtask 2.2: Add logic to verify the provided password against the stored hash using `security.verify_password`. Raise an `HTTPException` with status 400 for an incorrect password.

- [x] **Task 3: Implement Delayed Deletion Flag**
  - [x] Subtask 3.1: In the `delete_user_account` service, after successful password verification, set the user's `is_active` flag to `False`.
  - [x] Subtask 3.2: Set the `deletion_requested_at` timestamp to the current UTC time.
  - [x] Subtask 3.3: Ensure the logic does **not** perform a hard or soft delete. It only marks the account for future deletion by a background process.

- [x] **Task 4: Update Integration and Unit Tests**
  - [x] Subtask 4.1: Modify existing tests in `tests/integration/test_users.py` to pass the `current_password` in the request body for the deletion endpoint.
  - [x] Subtask 4.2: Add a new integration test to confirm that attempting to delete with an incorrect password fails with a 400 error.
  - [x] Subtask 4.3: Add a new unit test in `tests/unit/test_user_service.py` to verify the password check logic within the service.
  - [x] Subtask 4.4: Ensure all tests correctly check that `is_active` is `False` and `deletion_requested_at` is set, while `is_deleted` remains `False`.

## Dev Notes

### Objective
To correctly implement the user account deletion feature by adding a required password re-authentication step and marking the account for a delayed deletion, aligning the implementation with AC2 and AC4.

### Technical Implementation Guide
1.  **Endpoint Modification (`users.py`):**
    - The `delete_me` endpoint signature must change to accept the new `UserDeletionRequest` schema.
    - The `current_password` from the request body will be passed to the `user_service.delete_user_account` function.

2.  **Schema (`user.py`):**
    - Create a simple Pydantic schema `UserDeletionRequest` with a single required field: `current_password: str`.

3.  **Service Logic (`user_service.py`):**
    - The `delete_user_account` function will now accept `current_password` as an argument.
    - **CRITICAL:** You must first verify the user's password using the existing `verify_password` utility. If it does not match, raise an `HTTPException(status_code=400, detail="Incorrect current password")`.
    - On successful verification, update the `User` model instance:
        - `db_user.is_active = False`
        - `db_user.deletion_requested_at = datetime.utcnow()`
    - Commit the changes to the session.
    - **DO NOT** implement the background job for the 24-hour deletion. The scope of this story is only to *mark* the user for deletion. The actual removal will be handled by a separate process.

4.  **Testing (`test_users.py`, `test_user_service.py`):**
    - Your primary focus is to test the re-authentication flow.
    - Ensure you test the negative path (incorrect password) and verify the 400 error.
    - For the positive path, assert that the user object in the database has `is_active=False` and a valid `deletion_requested_at` timestamp after the call.

## Dev Agent Record

### File List
- `user-management-service/app/api/v1/endpoints/users.py` (modified)
- `user-management-service/app/schemas/user.py` (modified)
- `user-management-service/app/services/user_service.py` (modified)
- `user-management-service/tests/integration/test_users.py` (modified)
- `user-management-service/tests/unit/test_user_service.py` (modified)

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. The developer correctly addressed all issues from the previous QA failure, following the updated tasks precisely. The code is clean, adheres to project architecture, and is well-tested.

### Refactoring Performed

No refactoring was necessary. The code quality was already high.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

All required items from the previous review have been addressed.

### Security Review

The critical security vulnerability (deletion without re-authentication) has been resolved.

### Performance Considerations

No performance issues were identified.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.5-delete-user-account.yml

### Recommended Status

✓ Ready for Done
