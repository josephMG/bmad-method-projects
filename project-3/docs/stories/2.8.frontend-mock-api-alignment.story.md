# Story 2.8: Frontend Mock API Alignment for User Management

**As a** frontend developer
**I want to** ensure that frontend integration tests accurately reflect backend API contracts for user management
**So that** I can have confidence in the frontend's interaction with the backend and prevent integration issues.

This story focuses on aligning the mock API definitions in `@nextjs-frontend` integration tests with the `@user-management-service` backend's API schemas for user management (registration, login, password change, profile update, and account deletion).

## Status

- **Current Status:** Completed
- **Priority:** Medium
- **Sprint:** [To be assigned]

## Acceptance Criteria

1.  The mock API for `POST /api/v1/register` in `RegistrationForm.integration.test.tsx` accurately reflects the `UserCreate` request body and returns a `UserRead` response with a valid UUID for the `id` field.
2.  The mock API for `POST /api/v1/register` in `RegistrationForm.integration.test.tsx` returns an appropriate error response (e.g., 400 Bad Request) for duplicate email or username.
3.  The mock API for `POST /api/v1/token` in `LoginForm.integration.test.tsx` accurately reflects the `OAuth2PasswordRequestForm` request body and returns a `Token` response.
4.  The mock API for `POST /api/v1/token` in `LoginForm.integration.test.tsx` returns an appropriate error response (e.g., 401 Unauthorized) for invalid credentials.
5.  The mock API for `PUT /api/v1/users/me/password` in `ChangePasswordForm.integration.test.tsx` accurately reflects the `PasswordUpdate` request body and returns an `HTTP_204_NO_CONTENT` status on success.
6.  The mock API for `PUT /api/v1/users/me/password` in `ChangePasswordForm.integration.test.tsx` returns an appropriate error response (e.g., 400 Bad Request) for an incorrect current password.
7.  The mock API for `GET /api/v1/users/me` in `ProfileForm.integration.test.tsx` returns a `UserRead` response with a valid UUID for the `id` field.
8.  The mock API for `PUT /api/v1/users/me` in `ProfileForm.integration.test.tsx` accurately reflects the `UserUpdate` request body and returns an updated `UserRead` response with a valid UUID for the `id` field.
9.  The mock API for `PUT /api/v1/users/me` in `ProfileForm.integration.test.tsx` returns an appropriate error response (e.g., 400 Bad Request) for a duplicate email (if applicable).
10. The mock API for `DELETE /api/v1/users/me` in `DeleteAccount.integration.test.tsx` accurately reflects the `UserDelete` request body and returns an `HTTP_204_NO_CONTENT` status on success.
11. The mock API for `DELETE /api/v1/users/me` in `DeleteAccount.integration.test.tsx` returns an appropriate error response (e.g., 400 Bad Request) for an incorrect current password.
12. All affected frontend integration tests pass successfully after the mock API adjustments.

## Tasks / Subtasks

1. [x] **Review Backend API Schemas (AC: 1-11):**
    - Examine `user-management-service/app/schemas/user.py` for `UserCreate`, `UserRead`, `Token`, `PasswordUpdate`, `UserUpdate`, and `UserDelete` definitions.
    - Examine `user-management-service/app/api/v1/endpoints/auth.py` for `/register` and `/token` endpoint details.
    - Examine `user-management-service/app/api/v1/endpoints/users.py` for `/users/me` related endpoint details.
2. [x] **Identify Frontend Mock API Files (AC: 1-11):**
    - List contents of `nextjs-frontend/tests` to locate relevant integration test files.
    - Identify files containing mock API definitions for user management.
3. [x] **Update Registration Mock API (AC: 1-2):**
    - Modify `nextjs-frontend/tests/integration/RegistrationForm.integration.test.tsx` to align mock response with `UserRead` schema, including a valid UUID for `id`, and handle duplicate email/username errors.
4. [x] **Verify Login Mock API (AC: 3-4):**
    - Confirm `nextjs-frontend/tests/integration/LoginForm.integration.test.tsx` mock API aligns with `OAuth2PasswordRequestForm` and `Token` schema, and handles invalid credentials errors.
5. [x] **Update Change Password Mock API (AC: 5-6):**
    - Modify `nextjs-frontend/tests/integration/ChangePasswordForm.integration.test.tsx` to return `HTTP_204_NO_CONTENT` on success, and handle incorrect current password errors.
6. [x] **Update Profile Update Mock API (AC: 8-9):**
    - Modify `nextjs-frontend/tests/integration/ProfileForm.integration.test.tsx` to align mock responses with `UserRead` schema, including a valid UUID for `id`, and handle duplicate email errors (if applicable).
7. [x] **Verify Profile Fetch Mock API (AC: 7):**
    - Confirm `nextjs-frontend/tests/integration/ProfileForm.integration.test.tsx` mock API for `GET /api/v1/users/me` returns a `UserRead` response with a valid UUID for the `id` field.
8. [x] **Verify Delete Account Mock API (AC: 10-11):**
    - Confirm `nextjs-frontend/tests/integration/DeleteAccount.integration.test.tsx` mock API aligns with `UserDelete` schema and `HTTP_204_NO_CONTENT` on success, and handles incorrect current password errors.
9. [x] **Run Frontend Tests (AC: 12):**
    - Execute all relevant frontend integration tests to ensure they pass after the mock API adjustments.

## Dev Notes

### Architectural Context

This story ensures `@nextjs-frontend` integration tests accurately simulate `@user-management-service` API interactions. `msw` is used for frontend API mocking, aligning with backend FastAPI endpoints and Pydantic schemas.

#### Backend API Schemas Summary

- **UserCreate (Request Body for /register):**
  - `email` (EmailStr)
  - `username` (str, min_length=3, max_length=50)
  - `password` (str, min_length=8)
  - `full_name` (str | None, max_length=100)
- **UserRead (Response Body for /register, /users/me GET/PUT):**
  - `id` (UUID)
  - `email` (EmailStr)
  - `username` (str)
  - `full_name` (str | None)
  - `is_active` (bool)
  - `created_at` (datetime)
  - `updated_at` (datetime)
- **Token (Response Body for /token):**
  - `access_token` (str)
  - `token_type` (str, default="bearer")
- **UserUpdate (Request Body for /users/me PUT):**
  - `full_name` (str | None, max_length=100)
  - `email` (EmailStr | None)
- **PasswordUpdate (Request Body for /users/me/password PUT):**
  - `current_password` (str)
  - `new_password` (str, min_length=8)
- **UserDelete (Request Body for /users/me DELETE):**
  - `current_password` (str)

### Coding Standards

- Adhere to existing TypeScript and React coding standards within the `@nextjs-frontend` project.
- Ensure `msw` handlers are clearly defined and maintainable.
- Use meaningful variable names and comments where necessary.

### Testing

- **Frameworks:** Vitest, React Testing Library, MSW (Mock Service Worker).
- **Scope:** Integration tests for user registration, login, password change, profile update, and account deletion forms/pages.
- **Test Data:** Mock data should accurately reflect the backend schemas, including valid UUIDs where expected.
- **Error Handling:** Ensure tests cover both successful API responses and expected error scenarios (e.g., invalid credentials, duplicate email).

## Change Log

- **2025-10-01:** Initial draft created by PO.
- **2025-10-01:** Frontend mock API alignment implemented and tests passed by Dev Agent.
- **2025-10-02:** Fixed test errors in `LoginForm` component. Aligned `loginSchema` with `email` field and updated test assertions. All frontend tests now pass.

## Dev Agent Record

### Agent Model Used

- `bmad-dev` (Full Stack Developer) for implementation.
- `bmad-master` (BMad Master Task Executor) for checklist execution.

### Debug Log References

- `.ai/debug-log.md` (Refer to entries related to frontend mock API alignment and story creation on 2025-10-01)

### Completion Notes List

- Story drafted and initial tasks outlined.
- Mock API definitions in frontend tests reviewed and updated for registration, password change, and profile update.
- Login and delete account mock APIs verified.
- Encountered issues running frontend tests within Docker container (vitest not found, esbuild platform mismatch), resolved by rebuilding the Docker image and removing the node_modules volume mount.
- All frontend integration tests now pass successfully.
- Story Definition of Done checklist executed and reviewed.
- Identified and fixed test failures in `LoginForm` unit and integration tests. Corrected `loginSchema` to use `email` instead of `username` and updated test assertions for validation messages. Resolved issues with `Alert` component visibility in tests.

### File List

- `docs/stories/2.8.frontend-mock-api-alignment.story.md`
- `nextjs-frontend/tests/integration/RegistrationForm.integration.test.tsx`
- `nextjs-frontend/tests/integration/LoginForm.integration.test.tsx`
- `nextjs-frontend/tests/integration/ChangePasswordForm.integration.test.tsx`
- `nextjs-frontend/tests/integration/ProfileForm.integration.test.tsx`
- `nextjs-frontend/tests/integration/DeleteAccount.integration.test.tsx`
- `user-management-service/app/api/v1/endpoints/auth.py`
- `user-management-service/app/api/v1/endpoints/users.py`
- `user-management-service/app/schemas/user.py`

## QA Results

- **Status:** PASS
- **Date:** 2025-10-02
- **Tester:** Quinn (Test Architect & Quality Advisor)
- **Findings:** All frontend unit and integration tests related to user management API alignment passed successfully. The `LoginForm` component was updated to correctly send `username` instead of `email` to the backend, resolving the `username=undefined` issue. Mock API definitions accurately reflect backend API contracts.
- **Conclusion:** The frontend mock API alignment for user management is confirmed and meets the acceptance criteria.
